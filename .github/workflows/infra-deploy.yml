name: Infrastructure Deployment

on:
  workflow_dispatch:
    inputs:
      stage:
        description: 'Deployment stage (dev/staging/prod)'
        required: true
        default: 'dev'
        type: choice
        options:
          - dev
          - staging
          - prod

env:
  AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
  AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
  AWS_REGION: ${{ vars.AWS_REGION || 'ap-southeast-1' }}
  STAGE: ${{ inputs.stage || vars.STAGE || 'dev' }}
  db_name: ${{ vars.DB_RNAME }}
  db_username: ${{ vars.DB_USERNAME }}
  db_password: ${{ secrets.DB_PASSWORD }}
  amplify_repository_url: ${{ vars.AMPLIFY_REPOSITORY_URL }}
  devops_token: ${{ secrets.DEVOPS_TOKEN }}
  TF_VERSION: '1.13.4'

jobs:
  deploy-infrastructure:
    name: Deploy AWS Infrastructure
    runs-on: ubuntu-latest
    environment: ${{ inputs.stage || 'dev' }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}
          terraform_wrapper: false

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Terraform Init
        working-directory: ./terraform
        run: |
          terraform init \
            -backend-config="bucket=${{ vars.TERRAFORM_STATE_BUCKET || 'flowgenie-terraform-state' }}" \
            -backend-config="key=${{ env.STAGE }}/terraform.tfstate" \
            -backend-config="region=${{ env.AWS_REGION }}"

      #- name: Terraform Validate
      #  working-directory: ./terraform
      #  run: terraform validate

      - name: Terraform Plan
        working-directory: ./terraform
        run: |
          terraform plan \
            -var="stage=${{ env.STAGE }}" \
            -var="aws_region=${{ env.AWS_REGION }}" \
            -var="db_NAME=${{ env.db_name }}" \
            -var="db_username=${{ env.db_username }}" \
            -var="db_password=${{ env.db_password }}" \
            -var="amplify_repository_url=${{ env.amplify_repository_url }}" \
            -var="devops_token=${{ env.devops_token }}" \
            -out=tfplan

      - name: Terraform Apply
        working-directory: ./terraform
        run: terraform apply -auto-approve tfplan

      - name: Export Terraform Outputs
        id: terraform-outputs
        working-directory: ./terraform
        run: |
          echo "amplify_app_id=$(terraform output -raw amplify_app_id 2>/dev/null || echo '')" >> $GITHUB_OUTPUT
          echo "amplify_app_url=$(terraform output -raw amplify_app_url 2>/dev/null || echo '')" >> $GITHUB_OUTPUT
          echo "api_gateway_url=$(terraform output -raw api_gateway_url 2>/dev/null || echo '')" >> $GITHUB_OUTPUT
          echo "api_gateway_arn=$(terraform output -raw api_gateway_arn 2>/dev/null || echo '')" >> $GITHUB_OUTPUT
          echo "rds_endpoint=$(terraform output -raw rds_endpoint 2>/dev/null || echo '')" >> $GITHUB_OUTPUT
          echo "rds_arn=$(terraform output -raw rds_arn 2>/dev/null || echo '')" >> $GITHUB_OUTPUT
          echo "redis_endpoint=$(terraform output -raw redis_endpoint 2>/dev/null || echo '')" >> $GITHUB_OUTPUT
          echo "redis_arn=$(terraform output -raw redis_arn 2>/dev/null || echo '')" >> $GITHUB_OUTPUT
          echo "ecs_cluster_arn=$(terraform output -raw ecs_cluster_arn 2>/dev/null || echo '')" >> $GITHUB_OUTPUT
          echo "ecs_service_arn=$(terraform output -raw ecs_service_arn 2>/dev/null || echo '')" >> $GITHUB_OUTPUT

      - name: Set GitHub Environment Variables
        run: |
          echo "Setting GitHub environment variables for ${{ env.STAGE }}"
          # Note: These would need to be set via GitHub API or manually in repository settings
          # This is a placeholder showing what values should be stored
          echo "AMPLIFY_APP_ID=${{ steps.terraform-outputs.outputs.amplify_app_id }}"
          echo "API_GATEWAY_URL=${{ steps.terraform-outputs.outputs.api_gateway_url }}"
          echo "RDS_ENDPOINT=${{ steps.terraform-outputs.outputs.rds_endpoint }}"
          echo "REDIS_ENDPOINT=${{ steps.terraform-outputs.outputs.redis_endpoint }}"

      - name: Summary
        run: |
          echo "## Infrastructure Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Stage:** ${{ env.STAGE }}" >> $GITHUB_STEP_SUMMARY
          echo "**Region:** ${{ env.AWS_REGION }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Deployed Resources:" >> $GITHUB_STEP_SUMMARY
          echo "- Amplify App ID: ${{ steps.terraform-outputs.outputs.amplify_app_id }}" >> $GITHUB_STEP_SUMMARY
          echo "- Amplify App URL: ${{ steps.terraform-outputs.outputs.amplify_app_url }}" >> $GITHUB_STEP_SUMMARY
          echo "- API Gateway URL: ${{ steps.terraform-outputs.outputs.api_gateway_url }}" >> $GITHUB_STEP_SUMMARY
          echo "- RDS Endpoint: ${{ steps.terraform-outputs.outputs.rds_endpoint }}" >> $GITHUB_STEP_SUMMARY
          echo "- Redis Endpoint: ${{ steps.terraform-outputs.outputs.redis_endpoint }}" >> $GITHUB_STEP_SUMMARY
          echo "- ECS Cluster ARN: ${{ steps.terraform-outputs.outputs.ecs_cluster_arn }}" >> $GITHUB_STEP_SUMMARY

