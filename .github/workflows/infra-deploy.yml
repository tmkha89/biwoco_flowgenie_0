name: Infrastructure Deployment

on:
  workflow_dispatch:
    branches:
      - main
      - features/pipeline_backend
    inputs:
      stage:
        description: 'Deployment stage (dev/staging/prod)'
        required: true
        default: 'dev'
        type: choice
        options:
          - dev
          - staging
          - prod

env:
  AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
  AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
  AWS_REGION: ${{ vars.AWS_REGION || 'ap-southeast-1' }}
  STAGE: ${{ inputs.stage || vars.STAGE || 'dev' }}
  db_name: ${{ vars.DB_NAME }}
  db_username: ${{ vars.DB_USERNAME }}
  db_password: ${{ secrets.DB_PASSWORD }}
  amplify_repository_url: ${{ vars.AMPLIFY_REPOSITORY_URL }}
  devops_token: ${{ secrets.DEVOPS_TOKEN }}
  TF_VERSION: '1.13.4'

jobs:
  deploy-infrastructure:
    name: Deploy AWS Infrastructure
    runs-on: ubuntu-latest
    environment: ${{ inputs.stage || 'dev' }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}
          terraform_wrapper: false

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Terraform Init
        working-directory: ./terraform
        run: |
          terraform init \
            -backend-config="bucket=${{ vars.TERRAFORM_STATE_BUCKET || 'flowgenie-terraform-state' }}" \
            -backend-config="key=${{ env.STAGE }}/terraform.tfstate" \
            -backend-config="region=${{ env.AWS_REGION }}"

      #- name: Terraform Validate
      #  working-directory: ./terraform
      #  run: terraform validate

      - name: Terraform Plan
        working-directory: ./terraform
        id: terraform-plan
        continue-on-error: false
        run: |
          set -e
          echo "ðŸ” Running Terraform Plan..."
          echo "Stage: ${{ env.STAGE }}"
          echo "Region: ${{ env.AWS_REGION }}"
          echo ""
          
          # Run terraform plan with detailed output
          set +e
          terraform plan \
            -detailed-exitcode \
            -var="stage=${{ env.STAGE }}" \
            -var="aws_region=${{ env.AWS_REGION }}" \
            -var="db_name=${{ env.db_name }}" \
            -var="db_username=${{ env.db_username }}" \
            -var="db_password=${{ env.db_password }}" \
            -var="amplify_repository_url=${{ env.amplify_repository_url }}" \
            -var="devops_token=${{ secrets.DEVOPS_TOKEN }}" \
            -out=tfplan 2>&1 | tee plan_output.txt
          
          # Capture exit code from terraform plan
          PLAN_EXIT_CODE=${PIPESTATUS[0]}
          set -e
          
          # Terraform plan exit codes:
          # 0 = success with no changes
          # 1 = error
          # 2 = success with changes
          
          if [ "$PLAN_EXIT_CODE" -eq 1 ]; then
            echo ""
            echo "âŒâŒâŒ Terraform Plan failed with errors! âŒâŒâŒ"
            echo ""
            echo "=========================================="
            echo "FULL ERROR OUTPUT"
            echo "=========================================="
            cat plan_output.txt
            echo ""
            echo "=========================================="
            echo "END ERROR OUTPUT"
            echo "=========================================="
            echo ""
            echo "=========================================="
            echo "TROUBLESHOOTING INFORMATION"
            echo "=========================================="
            echo ""
            echo "1. Checking Terraform version:"
            terraform version
            echo ""
            echo "2. Validating Terraform configuration:"
            terraform validate || echo "âš ï¸ Validation also failed"
            echo ""
            echo "3. Checking for syntax errors:"
            terraform fmt -check -recursive || echo "âš ï¸ Formatting issues found"
            echo ""
            echo "4. Common issues to check:"
            echo "   - Verify all required variables are provided"
            echo "   - Check for resource naming conflicts"
            echo "   - Verify AWS credentials have necessary permissions"
            echo "   - Check resource quotas and limits in AWS"
            echo "   - Verify VPC, subnets, and security groups exist"
            echo "   - Check ECR repository exists (if using existing)"
            echo ""
            exit 1
          elif [ "$PLAN_EXIT_CODE" -eq 2 ]; then
            echo "âœ… Terraform Plan completed - changes detected"
            echo "plan_has_changes=true" >> $GITHUB_OUTPUT
          elif [ "$PLAN_EXIT_CODE" -eq 0 ]; then
            echo "âœ… Terraform Plan completed - no changes"
            echo "plan_has_changes=false" >> $GITHUB_OUTPUT
          fi
          
          # Save plan output for later steps
          echo "plan_exit_code=$PLAN_EXIT_CODE" >> $GITHUB_OUTPUT

      - name: Show Terraform Plan Summary
        if: always()
        working-directory: ./terraform
        run: |
          echo "## ðŸ“‹ Terraform Plan Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ -f plan_output.txt ]; then
            echo "### Plan Output" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            cat plan_output.txt >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ Plan output file not found" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Terraform Apply
        if: steps.terraform-plan.outputs.plan_has_changes == 'true'
        working-directory: ./terraform
        continue-on-error: false
        run: |
          set -e
          echo "ðŸš€ Applying Terraform changes..."
          echo ""
          
          # Run terraform apply with detailed output
          set +e
          terraform apply \
            -auto-approve \
            tfplan 2>&1 | tee apply_output.txt
          
          # Capture exit code from terraform apply
          APPLY_EXIT_CODE=${PIPESTATUS[0]}
          set -e
          
          if [ "$APPLY_EXIT_CODE" -ne 0 ]; then
            echo ""
            echo "âŒâŒâŒ Terraform Apply failed! âŒâŒâŒ"
            echo ""
            echo "=========================================="
            echo "FULL ERROR OUTPUT"
            echo "=========================================="
            cat apply_output.txt
            echo ""
            echo "=========================================="
            echo "END ERROR OUTPUT"
            echo "=========================================="
            echo ""
            echo "=========================================="
            echo "TROUBLESHOOTING INFORMATION"
            echo "=========================================="
            echo ""
            echo "1. Checking Terraform state:"
            terraform state list 2>&1 | head -20 || echo "âš ï¸ Could not list state"
            echo ""
            echo "2. Checking for partial resource creation:"
            echo "   Review the error above to identify which resource failed"
            echo ""
            echo "3. Common issues to check:"
            echo "   - Verify AWS credentials have necessary permissions"
            echo "   - Check resource quotas and limits in AWS"
            echo "   - Verify all required variables are set"
            echo "   - Check for resource naming conflicts"
            echo "   - Verify VPC, subnets, and security groups exist"
            echo "   - Check ECR repository exists and is accessible"
            echo "   - Verify IAM roles and policies are correct"
            echo "   - Check for dependency issues (e.g., VPC connector)"
            echo ""
            echo "4. To manually fix:"
            echo "   - Review AWS Console for partially created resources"
            echo "   - Check CloudWatch Logs for App Runner/Lambda errors"
            echo "   - Verify network connectivity (VPC, subnets, security groups)"
            echo ""
            exit 1
          fi
          
          echo "âœ… Terraform Apply completed successfully"

      - name: Show Terraform Apply Summary
        if: always()
        working-directory: ./terraform
        run: |
          echo "## âœ… Terraform Apply Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ -f apply_output.txt ]; then
            echo "### Apply Output" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            tail -100 apply_output.txt >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          fi

      - name: Terraform Apply (No Changes)
        if: steps.terraform-plan.outputs.plan_has_changes != 'true'
        working-directory: ./terraform
        run: |
          echo "â„¹ï¸ No changes detected in Terraform plan - skipping apply"
          echo "âœ… Infrastructure is up to date"

      - name: Export Terraform Outputs
        id: terraform-outputs
        working-directory: ./terraform
        run: |
          echo "amplify_app_id=$(terraform output -raw amplify_app_id 2>/dev/null || echo '')" >> $GITHUB_OUTPUT
          echo "amplify_app_url=$(terraform output -raw amplify_app_url 2>/dev/null || echo '')" >> $GITHUB_OUTPUT
          echo "api_gateway_url=$(terraform output -raw api_gateway_url 2>/dev/null || echo '')" >> $GITHUB_OUTPUT
          echo "api_gateway_arn=$(terraform output -raw api_gateway_arn 2>/dev/null || echo '')" >> $GITHUB_OUTPUT
          echo "rds_endpoint=$(terraform output -raw rds_endpoint 2>/dev/null || echo '')" >> $GITHUB_OUTPUT
          echo "rds_arn=$(terraform output -raw rds_arn 2>/dev/null || echo '')" >> $GITHUB_OUTPUT
          echo "redis_endpoint=$(terraform output -raw redis_endpoint 2>/dev/null || echo '')" >> $GITHUB_OUTPUT
          echo "redis_arn=$(terraform output -raw redis_arn 2>/dev/null || echo '')" >> $GITHUB_OUTPUT
          echo "ecs_cluster_arn=$(terraform output -raw ecs_cluster_arn 2>/dev/null || echo '')" >> $GITHUB_OUTPUT
          echo "ecs_service_arn=$(terraform output -raw ecs_service_arn 2>/dev/null || echo '')" >> $GITHUB_OUTPUT

      - name: Set GitHub Environment Variables
        run: |
          echo "Setting GitHub environment variables for ${{ env.STAGE }}"
          # Note: These would need to be set via GitHub API or manually in repository settings
          # This is a placeholder showing what values should be stored
          echo "AMPLIFY_APP_ID=${{ steps.terraform-outputs.outputs.amplify_app_id }}"
          echo "API_GATEWAY_URL=${{ steps.terraform-outputs.outputs.api_gateway_url }}"
          echo "RDS_ENDPOINT=${{ steps.terraform-outputs.outputs.rds_endpoint }}"
          echo "REDIS_ENDPOINT=${{ steps.terraform-outputs.outputs.redis_endpoint }}"

      - name: Summary
        run: |
          echo "## Infrastructure Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Stage:** ${{ env.STAGE }}" >> $GITHUB_STEP_SUMMARY
          echo "**Region:** ${{ env.AWS_REGION }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Deployed Resources:" >> $GITHUB_STEP_SUMMARY
          echo "- Amplify App ID: ${{ steps.terraform-outputs.outputs.amplify_app_id }}" >> $GITHUB_STEP_SUMMARY
          echo "- Amplify App URL: ${{ steps.terraform-outputs.outputs.amplify_app_url }}" >> $GITHUB_STEP_SUMMARY
          echo "- API Gateway URL: ${{ steps.terraform-outputs.outputs.api_gateway_url }}" >> $GITHUB_STEP_SUMMARY
          echo "- RDS Endpoint: ${{ steps.terraform-outputs.outputs.rds_endpoint }}" >> $GITHUB_STEP_SUMMARY
          echo "- Redis Endpoint: ${{ steps.terraform-outputs.outputs.redis_endpoint }}" >> $GITHUB_STEP_SUMMARY
          echo "- ECS Cluster ARN: ${{ steps.terraform-outputs.outputs.ecs_cluster_arn }}" >> $GITHUB_STEP_SUMMARY

