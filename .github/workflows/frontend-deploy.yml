name: Deploy Frontend to AWS Amplify

on:
  push:
    branches:
      - main
    paths:
      - 'frontend/**'
      - '.github/workflows/frontend-deploy.yml'
  workflow_dispatch:
    inputs:
      stage:
        description: 'Deployment stage (dev/staging/prod)'
        required: true
        default: 'dev'
        type: choice
        options:
          - dev
          - staging
          - prod

env:
  AWS_REGION: ${{ vars.AWS_REGION || 'ap-southeast-1' }}
  STAGE: ${{ inputs.stage || vars.STAGE || 'dev' }}
  NODE_VERSION: '24'

jobs:
  build-and-deploy:
    name: Build and Deploy Frontend to Amplify
    runs-on: ubuntu-latest
    environment: ${{ inputs.stage || vars.STAGE || 'dev' }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: DEBUG List Frontend Files
        run: |
          # List the contents of the 'frontend' directory
          echo "Listing contents of ./frontend/"
          ls -al ./frontend/
          
          # List the contents of the 'src' directory (where the error is happening)
          echo "Listing contents of ./frontend/src/"
          ls -al ./frontend/src/
          
          # Check for the specific entry file (main.tsx)
          if [ ! -f ./frontend/src/main.tsx ]; then
            echo "CRITICAL: ./frontend/src/main.tsx was NOT found!"
          fi

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          # Cache npm dependencies - only cache if lock file exists
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Install frontend dependencies
        working-directory: ./frontend
        run: npm ci

      - name: Run frontend linting
        working-directory: ./frontend
        run: npm run lint || echo "Linting failed but continuing..."

      - name: Build frontend
        working-directory: ./frontend
        env:
          VITE_API_URL: ${{ vars.VITE_API_URL || '' }}
          VITE_GOOGLE_CLIENT_ID: ${{ vars.VITE_GOOGLE_CLIENT_ID || '' }}
        run: npm run build

      - name: Prepare deployment artifacts
        working-directory: ./frontend
        run: |
          # Create a zip file of the dist folder for deployment
          cd dist
          zip -r ../deployment.zip .
          cd ..
          echo "Deployment zip created: $(ls -lh deployment.zip)"

      - name: Install jq for JSON parsing
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Get Amplify App ID
        id: get-amplify-app
        run: |
          # Try to get Amplify App ID from Terraform outputs
          APP_ID=$(aws amplify list-apps \
            --query "apps[?name=='${STAGE}-flowgenie-frontend'].appId" \
            --output text 2>/dev/null || echo "")
          
          if [ -z "$APP_ID" ]; then
            echo "Amplify app not found. Please ensure the Amplify app is created via Terraform first."
            exit 1
          fi
          
          echo "amplify_app_id=$APP_ID" >> $GITHUB_OUTPUT
          echo "Found Amplify App ID: $APP_ID"

      - name: Get Amplify Branch Name
        id: get-branch
        run: |
          # Use main branch as specified
          BRANCH_NAME="main"
          echo "amplify_branch=$BRANCH_NAME" >> $GITHUB_OUTPUT
          echo "Deploying to branch: $BRANCH_NAME"

      - name: Create and Start Amplify Deployment
        id: start-deployment
        working-directory: ./frontend
        run: |
          APP_ID=${{ steps.get-amplify-app.outputs.amplify_app_id }}
          BRANCH_NAME=${{ steps.get-branch.outputs.amplify_branch }}
          
          echo "Creating deployment for app: $APP_ID, branch: $BRANCH_NAME"
          
          # Try to use start-job first (for apps connected to repository)
          JOB_ID=$(aws amplify start-job \
            --app-id "$APP_ID" \
            --branch-name "$BRANCH_NAME" \
            --job-type RELEASE \
            --query 'jobSummary.jobId' \
            --output text 2>&1) || JOB_ID=""
          
          if [[ "$JOB_ID" == *"BadRequestException"* ]] || [[ "$JOB_ID" == *"not connected to a repository"* ]]; then
            echo "App not connected to repository, using deployment API instead..."
            
            # Create a deployment
            DEPLOYMENT_RESPONSE=$(aws amplify create-deployment \
              --app-id "$APP_ID" \
              --branch-name "$BRANCH_NAME" \
              --output json)
            
            DEPLOYMENT_ID=$(echo "$DEPLOYMENT_RESPONSE" | jq -r '.jobSummary.jobId')
            ZIP_UPLOAD_URL=$(echo "$DEPLOYMENT_RESPONSE" | jq -r '.zipUploadUrl')
            
            if [ -z "$DEPLOYMENT_ID" ] || [ "$DEPLOYMENT_ID" == "null" ]; then
              echo "Failed to create deployment"
              echo "Response: $DEPLOYMENT_RESPONSE"
              exit 1
            fi
            
            echo "Deployment ID: $DEPLOYMENT_ID"
            echo "Uploading artifacts to: $ZIP_UPLOAD_URL"
            
            # Upload the zip file
            curl -X PUT "$ZIP_UPLOAD_URL" \
              --upload-file deployment.zip \
              --header "Content-Type: application/zip"
            
            if [ $? -ne 0 ]; then
              echo "Failed to upload deployment artifacts"
              exit 1
            fi
            
            echo "Artifacts uploaded successfully"
            
            # Start the deployment
            START_RESPONSE=$(aws amplify start-deployment \
              --app-id "$APP_ID" \
              --branch-name "$BRANCH_NAME" \
              --job-id "$DEPLOYMENT_ID" \
              --output json)
            
            echo "deployment_id=$DEPLOYMENT_ID" >> $GITHUB_OUTPUT
            echo "deployment_type=deployment" >> $GITHUB_OUTPUT
            echo "Started deployment: $DEPLOYMENT_ID"
            
          elif [ -z "$JOB_ID" ] || [[ "$JOB_ID" == *"error"* ]]; then
            echo "Failed to start build or deployment"
            echo "Error: $JOB_ID"
            exit 1
          else
            echo "amplify_job_id=$JOB_ID" >> $GITHUB_OUTPUT
            echo "deployment_type=job" >> $GITHUB_OUTPUT
            echo "Started Amplify build job: $JOB_ID"
          fi

      - name: Wait for Amplify Deployment to Complete
        run: |
          APP_ID=${{ steps.get-amplify-app.outputs.amplify_app_id }}
          BRANCH_NAME=${{ steps.get-branch.outputs.amplify_branch }}
          DEPLOYMENT_TYPE=${{ steps.start-deployment.outputs.deployment_type }}
          
          if [ "$DEPLOYMENT_TYPE" = "deployment" ]; then
            DEPLOYMENT_ID=${{ steps.start-deployment.outputs.deployment_id }}
            echo "Waiting for deployment $DEPLOYMENT_ID to complete..."
            
            MAX_WAIT=1800  # 30 minutes
            ELAPSED=0
            SLEEP_INTERVAL=10
            
            while [ $ELAPSED -lt $MAX_WAIT ]; do
              STATUS=$(aws amplify get-job \
                --app-id "$APP_ID" \
                --branch-name "$BRANCH_NAME" \
                --job-id "$DEPLOYMENT_ID" \
                --query 'job.summary.status' \
                --output text 2>/dev/null || echo "PENDING")
              
              echo "Deployment status: $STATUS (Elapsed: ${ELAPSED}s)"
              
              if [ "$STATUS" = "SUCCEED" ]; then
                echo "Deployment completed successfully!"
                exit 0
              elif [ "$STATUS" = "FAILED" ] || [ "$STATUS" = "CANCELLED" ]; then
                echo "Deployment failed with status: $STATUS"
                
                # Get deployment logs
                echo "Fetching deployment logs..."
                aws amplify get-job \
                  --app-id "$APP_ID" \
                  --branch-name "$BRANCH_NAME" \
                  --job-id "$DEPLOYMENT_ID" \
                  --query 'job.steps[*].[stepName,status,logUrl]' \
                  --output table || true
                
                exit 1
              fi
              
              sleep $SLEEP_INTERVAL
              ELAPSED=$((ELAPSED + SLEEP_INTERVAL))
            done
            
            echo "Deployment timeout after ${MAX_WAIT} seconds"
            exit 1
          else
            # Original job-based wait logic
            JOB_ID=${{ steps.start-deployment.outputs.amplify_job_id }}
            echo "Waiting for build job $JOB_ID to complete..."
            
            MAX_WAIT=1800  # 30 minutes
            ELAPSED=0
            SLEEP_INTERVAL=10
            
            while [ $ELAPSED -lt $MAX_WAIT ]; do
              STATUS=$(aws amplify get-job \
                --app-id "$APP_ID" \
                --branch-name "$BRANCH_NAME" \
                --job-id "$JOB_ID" \
                --query 'job.summary.status' \
                --output text)
              
              echo "Build status: $STATUS (Elapsed: ${ELAPSED}s)"
              
              if [ "$STATUS" = "SUCCEED" ]; then
                echo "Build completed successfully!"
                exit 0
              elif [ "$STATUS" = "FAILED" ] || [ "$STATUS" = "CANCELLED" ]; then
                echo "Build failed with status: $STATUS"
                
                # Get build logs
                echo "Fetching build logs..."
                aws amplify get-job \
                  --app-id "$APP_ID" \
                  --branch-name "$BRANCH_NAME" \
                  --job-id "$JOB_ID" \
                  --query 'job.steps[*].[stepName,status,logUrl]' \
                  --output table || true
                
                exit 1
              fi
              
              sleep $SLEEP_INTERVAL
              ELAPSED=$((ELAPSED + SLEEP_INTERVAL))
            done
            
            echo "Build timeout after ${MAX_WAIT} seconds"
            exit 1
          fi

      - name: Get Amplify App URL
        id: get-url
        run: |
          APP_ID=${{ steps.get-amplify-app.outputs.amplify_app_id }}
          BRANCH_NAME=${{ steps.get-branch.outputs.amplify_branch }}
          
          # Get the app URL
          APP_URL="https://${BRANCH_NAME}.${APP_ID}.amplifyapp.com"
          
          echo "amplify_app_url=$APP_URL" >> $GITHUB_OUTPUT
          echo "Amplify App URL: $APP_URL"

      - name: Deployment Summary
        run: |
          echo "## Frontend Deployment Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Stage:** ${{ env.STAGE }}" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** ${{ steps.get-branch.outputs.amplify_branch }}" >> $GITHUB_STEP_SUMMARY
          echo "**App ID:** ${{ steps.get-amplify-app.outputs.amplify_app_id }}" >> $GITHUB_STEP_SUMMARY
          echo "**Deployment ID:** ${{ steps.start-deployment.outputs.deployment_id || steps.start-deployment.outputs.amplify_job_id }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**App URL:** [${{ steps.get-url.outputs.amplify_app_url }}](${{ steps.get-url.outputs.amplify_app_url }})" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Frontend has been successfully deployed to AWS Amplify!" >> $GITHUB_STEP_SUMMARY
