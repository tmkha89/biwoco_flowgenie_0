name: Deploy Frontend to AWS Amplify

on:
  push:
    branches:
      - main
    paths:
      - 'frontend/**'
      - '.github/workflows/frontend-deploy.yml'
  workflow_dispatch:
    inputs:
      stage:
        description: 'Deployment stage (dev/staging/prod)'
        required: true
        default: 'dev'
        type: choice
        options:
          - dev
          - staging
          - prod
      action:
        description: 'Action to perform'
        required: true
        default: 'deploy'
        type: choice
        options:
          - deploy
          - rollback
      deployment_id:
        description: 'Deployment ID to rollback to (leave empty to auto-select previous successful deployment)'
        required: false
        type: string

env:
  AWS_REGION: ${{ vars.AWS_REGION || 'ap-southeast-1' }}
  STAGE: ${{ inputs.stage || vars.STAGE || 'dev' }}
  NODE_VERSION: '24'

jobs:
  # Rollback job - runs when action is 'rollback'
  rollback:
    name: Rollback Frontend Deployment
    runs-on: ubuntu-latest
    environment: ${{ inputs.stage || vars.STAGE || 'dev' }}
    if: github.event_name == 'workflow_dispatch' && inputs.action == 'rollback'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch full history for commit checkout

      - name: Install jq for JSON parsing
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Get Amplify App ID
        id: get-amplify-app
        run: |
          echo "Looking for Amplify app: ${STAGE}-flowgenie-frontend"
          
          APP_ID=$(aws amplify list-apps \
            --query "apps[?name=='${STAGE}-flowgenie-frontend'].appId" \
            --output text 2>/dev/null || echo "")
          
          if [ -z "$APP_ID" ]; then
            echo ""
            echo "ERROR: Amplify app '${STAGE}-flowgenie-frontend' not found"
            exit 1
          fi
          
          echo "amplify_app_id=$APP_ID" >> $GITHUB_OUTPUT
          echo "Found Amplify App ID: $APP_ID"

      - name: Get Amplify Branch Name
        id: get-branch
        run: |
          BRANCH_NAME="main"
          echo "amplify_branch=$BRANCH_NAME" >> $GITHUB_OUTPUT
          echo "Rolling back branch: $BRANCH_NAME"

      - name: List Previous Deployments
        id: list-deployments
        run: |
          APP_ID=${{ steps.get-amplify-app.outputs.amplify_app_id }}
          BRANCH_NAME=${{ steps.get-branch.outputs.amplify_branch }}
          
          echo "Listing previous deployments for app: $APP_ID, branch: $BRANCH_NAME"
          
          # Get last 20 jobs (deployments)
          JOBS_JSON=$(aws amplify list-jobs \
            --app-id "$APP_ID" \
            --branch-name "$BRANCH_NAME" \
            --max-results 20 \
            --output json 2>/dev/null || echo "[]")
          
          # Extract successful deployments
          SUCCESSFUL_JOBS=$(echo "$JOBS_JSON" | jq -r '.jobSummaries[] | select(.status == "SUCCEED") | {jobId: .jobId, commitMessage: .commitMessage, commitId: .commitId, startTime: .startTime, endTime: .endTime} | @json' | jq -s '.')
          
          echo "Previous successful deployments:"
          echo "$SUCCESSFUL_JOBS" | jq -r '.[] | "ID: \(.jobId) | Commit: \(.commitId // "N/A") | Time: \(.startTime)"'
          
          # Save to output for next steps
          echo "deployments_json=$SUCCESSFUL_JOBS" >> $GITHUB_OUTPUT
          
          # Count successful deployments
          DEPLOYMENT_COUNT=$(echo "$SUCCESSFUL_JOBS" | jq 'length')
          echo "deployment_count=$DEPLOYMENT_COUNT" >> $GITHUB_OUTPUT
          
          if [ "$DEPLOYMENT_COUNT" -eq 0 ]; then
            echo ""
            echo "ERROR: No previous successful deployments found"
            echo "Cannot perform rollback - no previous successful deployment to rollback to"
            exit 1
          fi

      - name: Select Rollback Deployment
        id: select-rollback
        run: |
          APP_ID=${{ steps.get-amplify-app.outputs.amplify_app_id }}
          TARGET_DEPLOYMENT_ID="${{ inputs.deployment_id }}"
          DEPLOYMENTS_JSON='${{ steps.list-deployments.outputs.deployments_json }}'
          
          if [ -n "$TARGET_DEPLOYMENT_ID" ] && [ "$TARGET_DEPLOYMENT_ID" != "" ]; then
            # User specified a deployment ID
            echo "User specified deployment ID: $TARGET_DEPLOYMENT_ID"
            
            # Verify it exists and was successful
            DEPLOYMENT_EXISTS=$(echo "$DEPLOYMENTS_JSON" | jq -r ".[] | select(.jobId == \"$TARGET_DEPLOYMENT_ID\") | .jobId")
            
            if [ -z "$DEPLOYMENT_EXISTS" ]; then
              echo ""
              echo "ERROR: Deployment ID '$TARGET_DEPLOYMENT_ID' not found in successful deployments"
              echo "Available deployment IDs:"
              echo "$DEPLOYMENTS_JSON" | jq -r '.[] | "  - \(.jobId) (Commit: \(.commitId // "N/A"))"'
              exit 1
            fi
            
            ROLLBACK_DEPLOYMENT_ID="$TARGET_DEPLOYMENT_ID"
          else
            # Auto-select the second most recent successful deployment (skip the most recent one)
            echo "Auto-selecting previous successful deployment (skipping most recent)..."
            ROLLBACK_DEPLOYMENT_ID=$(echo "$DEPLOYMENTS_JSON" | jq -r '.[1].jobId // .[0].jobId')
            
            if [ -z "$ROLLBACK_DEPLOYMENT_ID" ] || [ "$ROLLBACK_DEPLOYMENT_ID" == "null" ]; then
              echo ""
              echo "ERROR: Could not determine rollback deployment"
              exit 1
            fi
          fi
          
          # Get deployment details
          ROLLBACK_COMMIT=$(echo "$DEPLOYMENTS_JSON" | jq -r ".[] | select(.jobId == \"$ROLLBACK_DEPLOYMENT_ID\") | .commitId // \"\"")
          ROLLBACK_TIME=$(echo "$DEPLOYMENTS_JSON" | jq -r ".[] | select(.jobId == \"$ROLLBACK_DEPLOYMENT_ID\") | .startTime // \"\"")
          
          echo "rollback_deployment_id=$ROLLBACK_DEPLOYMENT_ID" >> $GITHUB_OUTPUT
          echo "rollback_commit=$ROLLBACK_COMMIT" >> $GITHUB_OUTPUT
          echo "rollback_time=$ROLLBACK_TIME" >> $GITHUB_OUTPUT
          
          echo "Selected rollback deployment:"
          echo "  Deployment ID: $ROLLBACK_DEPLOYMENT_ID"
          echo "  Commit: $ROLLBACK_COMMIT"
          echo "  Time: $ROLLBACK_TIME"

      - name: Checkout Rollback Commit
        if: steps.select-rollback.outputs.rollback_commit != '' && steps.select-rollback.outputs.rollback_commit != 'null'
        run: |
          COMMIT=${{ steps.select-rollback.outputs.rollback_commit }}
          echo "Checking out commit: $COMMIT"
          
          if ! git checkout "$COMMIT"; then
            echo ""
            echo "WARNING: Could not checkout commit $COMMIT"
            echo "This may be normal if the app is not connected to a repository"
            echo "Proceeding with current commit..."
          else
            echo "Successfully checked out commit: $COMMIT"
            git log -1 --oneline
          fi

      - name: Setup Node.js for Rollback
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Install frontend dependencies for Rollback
        working-directory: ./frontend
        run: |
          echo "Installing frontend dependencies for rollback..."
          npm ci || npm install

      - name: Build Frontend for Rollback
        working-directory: ./frontend
        env:
          VITE_API_URL: ${{ vars.VITE_API_URL || '' }}
          VITE_GOOGLE_CLIENT_ID: ${{ vars.VITE_GOOGLE_CLIENT_ID || '' }}
        run: |
          echo "Building frontend for rollback..."
          npm run build
          
          # Verify dist folder was created
          if [ ! -d "dist" ] || [ -z "$(ls -A dist)" ]; then
            echo ""
            echo "ERROR: Build completed but dist folder is empty or missing"
            exit 1
          fi
          
          # Create deployment zip
          cd dist
          zip -r ../deployment.zip .
          cd ..
          
          if [ ! -f "deployment.zip" ]; then
            echo ""
            echo "ERROR: deployment.zip was not created"
            exit 1
          fi
          
          ZIP_SIZE=$(ls -lh deployment.zip | awk '{print $5}')
          echo "Rollback deployment zip created successfully (size: $ZIP_SIZE)"

      - name: Cancel Pending Deployments
        run: |
          APP_ID=${{ steps.get-amplify-app.outputs.amplify_app_id }}
          BRANCH_NAME=${{ steps.get-branch.outputs.amplify_branch }}
          
          echo "Checking for pending deployments..."
          PENDING_JOBS=$(aws amplify list-jobs \
            --app-id "$APP_ID" \
            --branch-name "$BRANCH_NAME" \
            --max-results 10 \
            --query "jobSummaries[?status=='PENDING' || status=='PROVISIONING' || status=='RUNNING'].jobId" \
            --output text 2>/dev/null || echo "")
          
          if [ -n "$PENDING_JOBS" ] && [ "$PENDING_JOBS" != "None" ]; then
            echo "Found pending deployments, cancelling them..."
            for JOB_ID in $PENDING_JOBS; do
              echo "  Cancelling job: $JOB_ID"
              aws amplify stop-job \
                --app-id "$APP_ID" \
                --branch-name "$BRANCH_NAME" \
                --job-id "$JOB_ID" 2>/dev/null || true
            done
            sleep 5
          fi

      - name: Create Rollback Deployment
        id: rollback-deploy
        working-directory: ./frontend
        run: |
          set +e
          APP_ID=${{ steps.get-amplify-app.outputs.amplify_app_id }}
          BRANCH_NAME=${{ steps.get-branch.outputs.amplify_branch }}
          
          echo "Creating rollback deployment..."
          
          # Create deployment
          DEPLOYMENT_RESPONSE=$(aws amplify create-deployment \
            --app-id "$APP_ID" \
            --branch-name "$BRANCH_NAME" \
            --output json 2>&1)
          DEPLOYMENT_EXIT_CODE=$?
          
          if [ $DEPLOYMENT_EXIT_CODE -ne 0 ]; then
            echo ""
            echo "ERROR: Failed to create rollback deployment"
            echo "Error: $DEPLOYMENT_RESPONSE"
            exit 1
          fi
          
          DEPLOYMENT_ID=$(echo "$DEPLOYMENT_RESPONSE" | jq -r '.jobId // .jobSummary.jobId')
          ZIP_UPLOAD_URL=$(echo "$DEPLOYMENT_RESPONSE" | jq -r '.zipUploadUrl // .jobSummary.zipUploadUrl')
          
          if [ -z "$DEPLOYMENT_ID" ] || [ "$DEPLOYMENT_ID" == "null" ]; then
            echo "ERROR: Failed to parse deployment response"
            exit 1
          fi
          
          echo "Uploading rollback artifacts..."
          
          # Upload zip
          UPLOAD_OUTPUT=$(curl -X PUT "$ZIP_UPLOAD_URL" \
            --upload-file deployment.zip \
            --header "Content-Type: application/zip" \
            --write-out "\nHTTP_CODE:%{http_code}" \
            --silent \
            --show-error \
            2>&1)
          HTTP_CODE=$(echo "$UPLOAD_OUTPUT" | grep "HTTP_CODE" | cut -d: -f2 || echo "N/A")
          
          if [ "$HTTP_CODE" != "200" ]; then
            echo "ERROR: Failed to upload artifacts (HTTP $HTTP_CODE)"
            exit 1
          fi
          
          # Start deployment
          echo "Starting rollback deployment..."
          START_RESPONSE=$(aws amplify start-deployment \
            --app-id "$APP_ID" \
            --branch-name "$BRANCH_NAME" \
            --job-id "$DEPLOYMENT_ID" \
            --output json 2>&1)
          START_EXIT_CODE=$?
          
          if [ $START_EXIT_CODE -ne 0 ]; then
            echo "ERROR: Failed to start rollback deployment"
            echo "Error: $START_RESPONSE"
            exit 1
          fi
          
          echo "rollback_deployment_id=$DEPLOYMENT_ID" >> $GITHUB_OUTPUT
          echo "Rollback deployment started: $DEPLOYMENT_ID"

      - name: Wait for Rollback to Complete
        run: |
          APP_ID=${{ steps.get-amplify-app.outputs.amplify_app_id }}
          BRANCH_NAME=${{ steps.get-branch.outputs.amplify_branch }}
          DEPLOYMENT_ID=${{ steps.rollback-deploy.outputs.rollback_deployment_id }}
          
          echo "Waiting for rollback deployment $DEPLOYMENT_ID to complete..."
          
          MAX_WAIT=1800
          ELAPSED=0
          SLEEP_INTERVAL=10
          
          while [ $ELAPSED -lt $MAX_WAIT ]; do
            STATUS=$(aws amplify get-job \
              --app-id "$APP_ID" \
              --branch-name "$BRANCH_NAME" \
              --job-id "$DEPLOYMENT_ID" \
              --query 'job.summary.status' \
              --output text 2>/dev/null || echo "PENDING")
            
            echo "Rollback status: $STATUS (Elapsed: ${ELAPSED}s)"
            
            if [ "$STATUS" = "SUCCEED" ]; then
              echo "Rollback completed successfully!"
              exit 0
            elif [ "$STATUS" = "FAILED" ] || [ "$STATUS" = "CANCELLED" ]; then
              echo ""
              echo "ERROR: Rollback failed with status: $STATUS"
              exit 1
            fi
            
            sleep $SLEEP_INTERVAL
            ELAPSED=$((ELAPSED + SLEEP_INTERVAL))
          done
          
          echo "ERROR: Rollback timeout"
          exit 1

      - name: Rollback Summary
        run: |
          echo "## Rollback Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Stage:** ${{ env.STAGE }}" >> $GITHUB_STEP_SUMMARY
          echo "**Rolled back to Deployment ID:** ${{ steps.select-rollback.outputs.rollback_deployment_id }}" >> $GITHUB_STEP_SUMMARY
          echo "**New Deployment ID:** ${{ steps.rollback-deploy.outputs.rollback_deployment_id }}" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ steps.select-rollback.outputs.rollback_commit }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Rollback has been successfully deployed!" >> $GITHUB_STEP_SUMMARY

  # Normal deployment job - runs when action is 'deploy' or on push
  build-and-deploy:
    name: Build and Deploy Frontend to Amplify
    runs-on: ubuntu-latest
    environment: ${{ inputs.stage || vars.STAGE || 'dev' }}
    if: github.event_name == 'push' || (github.event_name == 'workflow_dispatch' && (inputs.action == 'deploy' || inputs.action == ''))

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: DEBUG List Frontend Files
        run: |
          # List the contents of the 'frontend' directory
          echo "Listing contents of ./frontend/"
          ls -al ./frontend/
          
          # List the contents of the 'src' directory (where the error is happening)
          echo "Listing contents of ./frontend/src/"
          ls -al ./frontend/src/
          
          # Check for the specific entry file (main.tsx)
          if [ ! -f ./frontend/src/main.tsx ]; then
            echo "CRITICAL: ./frontend/src/main.tsx was NOT found!"
          fi

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          # Cache npm dependencies - only cache if lock file exists
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Install frontend dependencies
        working-directory: ./frontend
        run: |
          echo "ðŸ“¦ Installing frontend dependencies..."
          if ! npm ci; then
            echo ""
            echo "âŒ ERROR: Failed to install frontend dependencies"
            echo ""
            echo "This usually means package.json and package-lock.json are out of sync."
            echo "Fix: Run 'npm install' in the frontend directory and commit the updated package-lock.json"
            exit 1
          fi
          echo "âœ… Dependencies installed successfully"

      - name: Run frontend linting
        working-directory: ./frontend
        run: |
          echo "ðŸ” Running linting checks..."
          if ! npm run lint; then
            echo ""
            echo "âš ï¸  WARNING: Linting failed, but continuing with deployment..."
            echo "Please fix linting errors before the next deployment"
          else
            echo "âœ… Linting passed"
          fi

      - name: Build frontend
        working-directory: ./frontend
        env:
          VITE_API_URL: ${{ vars.VITE_API_URL || '' }}
          VITE_GOOGLE_CLIENT_ID: ${{ vars.VITE_GOOGLE_CLIENT_ID || '' }}
        run: |
          echo "ðŸ—ï¸  Building frontend application..."
          if ! npm run build; then
            echo ""
            echo "âŒ ERROR: Frontend build failed"
            echo ""
            echo "Common issues:"
            echo "  - Missing environment variables (VITE_API_URL, VITE_GOOGLE_CLIENT_ID)"
            echo "  - TypeScript compilation errors"
            echo "  - Import path errors"
            echo "  - Missing dependencies"
            exit 1
          fi
          
          # Verify dist folder was created
          if [ ! -d "dist" ] || [ -z "$(ls -A dist)" ]; then
            echo ""
            echo "âŒ ERROR: Build completed but dist folder is empty or missing"
            exit 1
          fi
          echo "âœ… Build completed successfully"

      - name: Prepare deployment artifacts
        working-directory: ./frontend
        run: |
          echo "ðŸ“¦ Preparing deployment artifacts..."
          
          if [ ! -d "dist" ]; then
            echo ""
            echo "âŒ ERROR: dist folder not found. Build must have failed."
            exit 1
          fi
          
          if [ -z "$(ls -A dist)" ]; then
            echo ""
            echo "âŒ ERROR: dist folder is empty. Build did not produce any output."
            exit 1
          fi
          
          cd dist
          if ! zip -r ../deployment.zip .; then
            echo ""
            echo "âŒ ERROR: Failed to create deployment zip file"
            exit 1
          fi
          cd ..
          
          if [ ! -f "deployment.zip" ]; then
            echo ""
            echo "âŒ ERROR: deployment.zip was not created"
            exit 1
          fi
          
          ZIP_SIZE=$(ls -lh deployment.zip | awk '{print $5}')
          echo "âœ… Deployment zip created successfully (size: $ZIP_SIZE)"

      - name: Install jq for JSON parsing
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Get Amplify App ID
        id: get-amplify-app
        run: |
          echo "ðŸ” Looking for Amplify app: ${STAGE}-flowgenie-frontend"
          
          APP_ID=$(aws amplify list-apps \
            --query "apps[?name=='${STAGE}-flowgenie-frontend'].appId" \
            --output text 2>/dev/null || echo "")
          
          if [ -z "$APP_ID" ]; then
            echo ""
            echo "âŒ ERROR: Amplify app '${STAGE}-flowgenie-frontend' not found"
            echo ""
            echo "Possible causes:"
            echo "  1. Amplify app was not created via Terraform"
            echo "  2. App name mismatch (expected: ${STAGE}-flowgenie-frontend)"
            echo "  3. AWS credentials don't have permission to list Amplify apps"
            echo ""
            echo "Available apps:"
            aws amplify list-apps --query "apps[*].[name,appId]" --output table 2>&1 || echo "  (Failed to list apps - check AWS credentials)"
            exit 1
          fi
          
          echo "amplify_app_id=$APP_ID" >> $GITHUB_OUTPUT
          echo "âœ… Found Amplify App ID: $APP_ID"

      - name: Get Amplify Branch Name
        id: get-branch
        run: |
          # Use main branch as specified
          BRANCH_NAME="main"
          echo "amplify_branch=$BRANCH_NAME" >> $GITHUB_OUTPUT
          echo "Deploying to branch: $BRANCH_NAME"

      - name: Check and Create Amplify Branch
        id: check-branch
        run: |
          APP_ID=${{ steps.get-amplify-app.outputs.amplify_app_id }}
          BRANCH_NAME=${{ steps.get-branch.outputs.amplify_branch }}
          
          echo "ðŸ” Checking if branch '$BRANCH_NAME' exists in Amplify app..."
          
          # Check if branch exists - suppress error output to handle gracefully
          set +e
          BRANCH_CHECK=$(aws amplify get-branch \
            --app-id "$APP_ID" \
            --branch-name "$BRANCH_NAME" \
            --query 'branch.branchName' \
            --output text 2>/dev/null)
          BRANCH_CHECK_EXIT_CODE=$?
          set -e
          
          # Check if branch exists (exit code 0 and output matches branch name)
          if [ $BRANCH_CHECK_EXIT_CODE -eq 0 ] && [ "$BRANCH_CHECK" == "$BRANCH_NAME" ]; then
            echo "âœ… Branch '$BRANCH_NAME' already exists in Amplify app"
            echo "branch_exists=true" >> $GITHUB_OUTPUT
          else
            # Check if error is because branch doesn't exist (expected case)
            if [ $BRANCH_CHECK_EXIT_CODE -ne 0 ]; then
              # Get the actual error message to check if it's "not found"
              BRANCH_ERROR=$(aws amplify get-branch \
                --app-id "$APP_ID" \
                --branch-name "$BRANCH_NAME" \
                --query 'branch.branchName' \
                --output text 2>&1 || true)
              
              # Check if it's a "not found" error (expected) vs other errors
              if [[ "$BRANCH_ERROR" == *"NotFoundException"* ]] || \
                 [[ "$BRANCH_ERROR" == *"not found"* ]] || \
                 [[ "$BRANCH_ERROR" == *"does not exist"* ]]; then
                echo "â„¹ï¸  Branch '$BRANCH_NAME' does not exist (this is expected if first deployment)"
              else
                echo ""
                echo "âš ï¸  WARNING: Could not check branch status. Error: $BRANCH_ERROR"
                echo "Attempting to create branch anyway..."
              fi
            else
              echo "âš ï¸  Branch check returned unexpected result: $BRANCH_CHECK"
              echo "Attempting to create branch anyway..."
            fi
            
            echo "Creating branch '$BRANCH_NAME'..."
            
            # Create the branch
            set +e
            CREATE_BRANCH_RESPONSE=$(aws amplify create-branch \
              --app-id "$APP_ID" \
              --branch-name "$BRANCH_NAME" \
              --enable-auto-build \
              --output json 2>&1)
            CREATE_BRANCH_EXIT_CODE=$?
            set -e
            
            if [ $CREATE_BRANCH_EXIT_CODE -ne 0 ]; then
              # Check if branch already exists (race condition or was created between check and create)
              if [[ "$CREATE_BRANCH_RESPONSE" == *"AlreadyExistsException"* ]] || \
                 [[ "$CREATE_BRANCH_RESPONSE" == *"already exists"* ]]; then
                echo "âœ… Branch '$BRANCH_NAME' already exists (created by another process)"
                echo "branch_exists=true" >> $GITHUB_OUTPUT
              else
                echo ""
                echo "âŒ ERROR: Failed to create branch '$BRANCH_NAME'"
                echo "Exit code: $CREATE_BRANCH_EXIT_CODE"
                echo "AWS CLI Error: $CREATE_BRANCH_RESPONSE"
                echo ""
                echo "Possible causes:"
                echo "  1. AWS credentials don't have permission to create branches (amplify:CreateBranch)"
                echo "  2. Invalid app ID"
                echo "  3. Network connectivity issues"
                echo ""
                echo "Fix: Ensure AWS credentials have 'amplify:CreateBranch' permission"
                exit 1
              fi
            else
              CREATED_BRANCH=$(echo "$CREATE_BRANCH_RESPONSE" | jq -r '.branch.branchName' 2>/dev/null)
              if [ "$CREATED_BRANCH" == "$BRANCH_NAME" ]; then
                echo "âœ… Successfully created branch '$BRANCH_NAME'"
                echo "branch_exists=false" >> $GITHUB_OUTPUT
              else
                echo ""
                echo "âŒ ERROR: Branch creation response unexpected"
                echo "Expected: $BRANCH_NAME"
                echo "Received: $CREATED_BRANCH"
                echo "Full response: $CREATE_BRANCH_RESPONSE"
                exit 1
              fi
            fi
          fi

      - name: Create and Start Amplify Deployment
        id: start-deployment
        working-directory: ./frontend
        run: |
          set +e  # Don't exit on error, we'll handle them manually
          APP_ID=${{ steps.get-amplify-app.outputs.amplify_app_id }}
          BRANCH_NAME=${{ steps.get-branch.outputs.amplify_branch }}
          
          echo "Creating deployment for app: $APP_ID, branch: $BRANCH_NAME"
          
          # Check for and cancel any pending/in-progress deployments
          echo "ðŸ” Checking for pending deployments..."
          PENDING_JOBS=$(aws amplify list-jobs \
            --app-id "$APP_ID" \
            --branch-name "$BRANCH_NAME" \
            --max-results 10 \
            --query "jobSummaries[?status=='PENDING' || status=='PROVISIONING' || status=='RUNNING'].jobId" \
            --output text 2>/dev/null || echo "")
          
          if [ -n "$PENDING_JOBS" ] && [ "$PENDING_JOBS" != "None" ]; then
            echo "âš ï¸  Found pending/in-progress deployments, cancelling them..."
            for JOB_ID in $PENDING_JOBS; do
              echo "  Cancelling job: $JOB_ID"
              STOP_RESPONSE=$(aws amplify stop-job \
                --app-id "$APP_ID" \
                --branch-name "$BRANCH_NAME" \
                --job-id "$JOB_ID" \
                --output json 2>&1)
              STOP_EXIT_CODE=$?
              
              if [ $STOP_EXIT_CODE -eq 0 ]; then
                echo "  âœ… Successfully cancelled job: $JOB_ID"
              else
                echo "  âš ï¸  Warning: Could not cancel job $JOB_ID (may have already completed)"
                echo "  Response: $STOP_RESPONSE"
              fi
            done
            
            # Wait a moment for cancellations to process
            echo "â³ Waiting 5 seconds for cancellations to complete..."
            sleep 5
          else
            echo "âœ… No pending deployments found"
          fi
          
          # Try to use start-job first (for apps connected to repository)
          JOB_OUTPUT=$(aws amplify start-job \
            --app-id "$APP_ID" \
            --branch-name "$BRANCH_NAME" \
            --job-type RELEASE \
            --query 'jobSummary.jobId' \
            --output text 2>&1)
          JOB_EXIT_CODE=$?
          
          if [ $JOB_EXIT_CODE -eq 0 ] && [ -n "$JOB_OUTPUT" ] && [[ ! "$JOB_OUTPUT" =~ ^[[:space:]]*$ ]]; then
            # Successfully started a job
            JOB_ID="$JOB_OUTPUT"
            echo "amplify_job_id=$JOB_ID" >> $GITHUB_OUTPUT
            echo "deployment_type=job" >> $GITHUB_OUTPUT
            echo "Started Amplify build job: $JOB_ID"
          else
            # Failed to start job - check if it's because app is not connected to repository
            if [[ "$JOB_OUTPUT" == *"BadRequestException"* ]] || \
               [[ "$JOB_OUTPUT" == *"not connected to a repository"* ]] || \
               [[ "$JOB_OUTPUT" == *"Operation not supported"* ]]; then
              echo "App not connected to repository, using deployment API instead..."
            else
              echo "Could not start job (exit code: $JOB_EXIT_CODE), using deployment API instead..."
              echo "Error output: $JOB_OUTPUT"
                                        fi
              
              # Use deployment API
              echo "Creating deployment..."
              DEPLOYMENT_RESPONSE=$(aws amplify create-deployment \
                --app-id "$APP_ID" \
                --branch-name "$BRANCH_NAME" \
                --output json 2>&1)
              DEPLOYMENT_EXIT_CODE=$?
              
              if [ $DEPLOYMENT_EXIT_CODE -ne 0 ]; then
                                echo ""
                echo "âŒ ERROR: Failed to create deployment"
                echo "Exit code: $DEPLOYMENT_EXIT_CODE"
                echo "AWS CLI Error: $DEPLOYMENT_RESPONSE"
                echo ""
                echo "Possible causes:"
                echo "  1. Invalid app ID or branch name"
                echo "  2. AWS credentials don't have Amplify deployment permissions"
                echo "  3. Branch '${BRANCH_NAME}' was just created but not ready yet (unlikely)"
                echo ""
                echo "Note: Branch should have been auto-created in the previous step"
                exit 1
              fi
              
              DEPLOYMENT_ID=$(echo "$DEPLOYMENT_RESPONSE" | jq -r '.jobId // .jobSummary.jobId' 2>/dev/null)
              ZIP_UPLOAD_URL=$(echo "$DEPLOYMENT_RESPONSE" | jq -r '.zipUploadUrl // .jobSummary.zipUploadUrl' 2>/dev/null)
              
              if [ $? -ne 0 ] || [ -z "$DEPLOYMENT_ID" ] || [ "$DEPLOYMENT_ID" == "null" ]; then
                echo ""
                echo "âŒ ERROR: Failed to parse deployment response"
                echo "DEPLOYMENT_ID: $DEPLOYMENT_ID"
                echo "ZIP_UPLOAD_URL: $ZIP_UPLOAD_URL"
                echo "Full response: $DEPLOYMENT_RESPONSE"
                exit 1
              fi
              
              echo "âœ… Deployment ID: $DEPLOYMENT_ID"
              echo "ðŸ“¤ Uploading artifacts..."
              
              if [ ! -f deployment.zip ]; then
                echo ""
                echo "âŒ ERROR: deployment.zip not found!"
                echo "Current directory: $(pwd)"
                ls -la
                exit 1
              fi
              
              UPLOAD_OUTPUT=$(curl -X PUT "$ZIP_UPLOAD_URL" \
                --upload-file deployment.zip \
                --header "Content-Type: application/zip" \
                --write-out "\nHTTP_CODE:%{http_code}" \
                --silent \
                --show-error \
                2>&1)
              UPLOAD_EXIT_CODE=$?
              HTTP_CODE=$(echo "$UPLOAD_OUTPUT" | grep "HTTP_CODE" | cut -d: -f2 || echo "N/A")
              
              if [ $UPLOAD_EXIT_CODE -ne 0 ] || [ "$HTTP_CODE" != "200" ]; then
                echo ""
                echo "âŒ ERROR: Failed to upload deployment artifacts"
                echo "Exit code: $UPLOAD_EXIT_CODE"
                echo "HTTP code: $HTTP_CODE"
                echo "Possible causes: Upload URL expired, network issues, or file too large"
                exit 1
              fi
              
              echo "âœ… Artifacts uploaded successfully"
              
              echo "ðŸš€ Starting deployment..."
              START_RESPONSE=$(aws amplify start-deployment \
                --app-id "$APP_ID" \
                --branch-name "$BRANCH_NAME" \
                --job-id "$DEPLOYMENT_ID" \
                --output json 2>&1)
              START_EXIT_CODE=$?
              
              if [ $START_EXIT_CODE -ne 0 ]; then
                echo ""
                echo "âŒ ERROR: Failed to start deployment"
                echo "Exit code: $START_EXIT_CODE"
                echo "Error: $START_RESPONSE"
                exit 1
              fi
            
            echo "deployment_id=$DEPLOYMENT_ID" >> $GITHUB_OUTPUT
            echo "deployment_type=deployment" >> $GITHUB_OUTPUT
            echo "Started deployment: $DEPLOYMENT_ID"
          fi

      - name: Wait for Amplify Deployment to Complete
        run: |
          APP_ID=${{ steps.get-amplify-app.outputs.amplify_app_id }}
          BRANCH_NAME=${{ steps.get-branch.outputs.amplify_branch }}
          DEPLOYMENT_TYPE=${{ steps.start-deployment.outputs.deployment_type }}
          
          if [ "$DEPLOYMENT_TYPE" = "deployment" ]; then
            DEPLOYMENT_ID=${{ steps.start-deployment.outputs.deployment_id }}
            echo "Waiting for deployment $DEPLOYMENT_ID to complete..."
            
            MAX_WAIT=1800  # 30 minutes
            ELAPSED=0
            SLEEP_INTERVAL=10
            
            while [ $ELAPSED -lt $MAX_WAIT ]; do
              STATUS=$(aws amplify get-job \
                --app-id "$APP_ID" \
                --branch-name "$BRANCH_NAME" \
                --job-id "$DEPLOYMENT_ID" \
                --query 'job.summary.status' \
                                --output text 2>/dev/null || echo "PENDING")
                
                echo "Deployment status: $STATUS (Elapsed: ${ELAPSED}s)"
                
                if [ "$STATUS" = "SUCCEED" ]; then
                  echo "âœ… Deployment completed successfully!"
                  exit 0
                elif [ "$STATUS" = "FAILED" ] || [ "$STATUS" = "CANCELLED" ]; then
                  echo ""
                  echo "âŒ ERROR: Deployment failed with status: $STATUS"
                  echo ""
                  echo "ðŸ“‹ Fetching deployment logs..."
                  aws amplify get-job \
                    --app-id "$APP_ID" \
                    --branch-name "$BRANCH_NAME" \
                    --job-id "$DEPLOYMENT_ID" \
                    --query 'job.steps[*].[stepName,status,logUrl]' \
                    --output table || true
                  echo ""
                  echo "ðŸ”— View logs: https://console.aws.amazon.com/amplify/home?region=${AWS_REGION}#/${APP_ID}/${BRANCH_NAME}/${DEPLOYMENT_ID}"
                  exit 1
                fi
              
                              sleep $SLEEP_INTERVAL
                ELAPSED=$((ELAPSED + SLEEP_INTERVAL))
              done
              
              echo ""
              echo "âŒ ERROR: Deployment timeout after ${MAX_WAIT} seconds (30 minutes)"
              echo ""
              echo "The deployment is still running but exceeded the timeout limit."
              echo "Check the deployment status in AWS Console:"
              echo "   https://console.aws.amazon.com/amplify/home?region=${AWS_REGION}#/${APP_ID}/${BRANCH_NAME}"
              exit 1
          else
            # Original job-based wait logic
            JOB_ID=${{ steps.start-deployment.outputs.amplify_job_id }}
            echo "Waiting for build job $JOB_ID to complete..."
            
            MAX_WAIT=1800  # 30 minutes
            ELAPSED=0
            SLEEP_INTERVAL=10
            
            while [ $ELAPSED -lt $MAX_WAIT ]; do
              STATUS=$(aws amplify get-job \
                --app-id "$APP_ID" \
                --branch-name "$BRANCH_NAME" \
                --job-id "$JOB_ID" \
                --query 'job.summary.status' \
                                --output text)
                
                echo "Build status: $STATUS (Elapsed: ${ELAPSED}s)"
                
                if [ "$STATUS" = "SUCCEED" ]; then
                  echo "âœ… Build completed successfully!"
                  exit 0
                elif [ "$STATUS" = "FAILED" ] || [ "$STATUS" = "CANCELLED" ]; then
                  echo ""
                  echo "âŒ ERROR: Build failed with status: $STATUS"
                  echo ""
                  echo "ðŸ“‹ Fetching build logs..."
                  aws amplify get-job \
                    --app-id "$APP_ID" \
                    --branch-name "$BRANCH_NAME" \
                    --job-id "$JOB_ID" \
                    --query 'job.steps[*].[stepName,status,logUrl]' \
                    --output table || true
                  echo ""
                  echo "ðŸ”— View logs: https://console.aws.amazon.com/amplify/home?region=${AWS_REGION}#/${APP_ID}/${BRANCH_NAME}/${JOB_ID}"
                  exit 1
                fi
              
                              sleep $SLEEP_INTERVAL
                ELAPSED=$((ELAPSED + SLEEP_INTERVAL))
              done
              
              echo ""
              echo "âŒ ERROR: Build timeout after ${MAX_WAIT} seconds (30 minutes)"
              echo ""
              echo "The build is still running but exceeded the timeout limit."
              echo "Check the build status in AWS Console:"
              echo "   https://console.aws.amazon.com/amplify/home?region=${AWS_REGION}#/${APP_ID}/${BRANCH_NAME}"
              exit 1
          fi

      - name: Get Amplify App URL
        id: get-url
        run: |
          APP_ID=${{ steps.get-amplify-app.outputs.amplify_app_id }}
          BRANCH_NAME=${{ steps.get-branch.outputs.amplify_branch }}
          
          # Get the app URL
          APP_URL="https://${BRANCH_NAME}.${APP_ID}.amplifyapp.com"
          
          echo "amplify_app_url=$APP_URL" >> $GITHUB_OUTPUT
          echo "Amplify App URL: $APP_URL"

      - name: Deployment Summary
        run: |
          echo "## Frontend Deployment Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Stage:** ${{ env.STAGE }}" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** ${{ steps.get-branch.outputs.amplify_branch }}" >> $GITHUB_STEP_SUMMARY
          echo "**App ID:** ${{ steps.get-amplify-app.outputs.amplify_app_id }}" >> $GITHUB_STEP_SUMMARY
          echo "**Deployment ID:** ${{ steps.start-deployment.outputs.deployment_id || steps.start-deployment.outputs.amplify_job_id }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**App URL:** [${{ steps.get-url.outputs.amplify_app_url }}](${{ steps.get-url.outputs.amplify_app_url }})" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Frontend has been successfully deployed to AWS Amplify!" >> $GITHUB_STEP_SUMMARY

      - name: Failure Summary
        if: failure()
        run: |
          echo "## âŒ Deployment Failed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Troubleshooting Steps:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "1. **Check the logs above** for the specific error message" >> $GITHUB_STEP_SUMMARY
          echo "2. **Verify AWS credentials** have necessary Amplify permissions" >> $GITHUB_STEP_SUMMARY
          echo "3. **Check Amplify app configuration** in AWS Console" >> $GITHUB_STEP_SUMMARY
          echo "4. **Verify environment variables** are set correctly" >> $GITHUB_STEP_SUMMARY
          echo "5. **Review build logs** in AWS Amplify Console" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Useful Links:" >> $GITHUB_STEP_SUMMARY
          echo "- [AWS Amplify Console](https://console.aws.amazon.com/amplify/home?region=${{ env.AWS_REGION }})" >> $GITHUB_STEP_SUMMARY
          echo "- [Workflow Run](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Common Issues:" >> $GITHUB_STEP_SUMMARY
          echo "- Build failures: Check TypeScript/compilation errors" >> $GITHUB_STEP_SUMMARY
          echo "- Missing files: Verify all source files are committed" >> $GITHUB_STEP_SUMMARY
          echo "- Permission errors: Verify IAM roles and policies" >> $GITHUB_STEP_SUMMARY
          echo "- Timeout: Large deployments may need more time" >> $GITHUB_STEP_SUMMARY
